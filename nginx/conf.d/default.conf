# ========================================
# Blue-Green 무중단 배포 Nginx 설정
# ========================================

# ========================================
# Upstream 설정 (Blue-Green)
# ========================================
upstream blue {
    server blue:8080 max_fails=3 fail_timeout=30s;
}

upstream green {
    server green:8081 max_fails=3 fail_timeout=30s;
}

# ========================================
# HTTP 서버 설정
# ========================================
server {
    listen 80;
    server_name localhost 54.116.17.176;

    # service-env.inc에서 활성 서버 설정 로드
    include /etc/nginx/conf.d/service-env.inc;

    # ====================================
    # Nginx 헬스체크 엔드포인트
    # ====================================
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # ====================================
    # Blue 서버 헬스체크 (관리용)
    # ====================================
    location /health/blue {
        access_log off;
        proxy_pass http://blue/actuator/health;
        proxy_set_header Host $host;
    }

    # ====================================
    # Green 서버 헬스체크 (관리용)
    # ====================================
    location /health/green {
        access_log off;
        proxy_pass http://green/actuator/health;
        proxy_set_header Host $host;
    }

    # ====================================
    # API 프록시 (활성 서버로 라우팅)
    # ====================================
    location / {
        # service-env.inc에서 설정한 $service_url 사용
        proxy_pass http://$service_url;

        # 헤더 설정
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # CORS (Vercel 프론트엔드 허용)
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;

        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # 타임아웃 설정
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # 버퍼링 설정
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # ====================================
    # SSE (Server-Sent Events) 지원
    # ====================================
    location /api/sse/ {
        proxy_pass http://$service_url;

        # SSE 필수 헤더
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        chunked_transfer_encoding off;

        # 헤더 설정
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE 타임아웃 (무제한)
        proxy_connect_timeout 1h;
        proxy_send_timeout 1h;
        proxy_read_timeout 1h;

        # 버퍼링 비활성화 (SSE 필수)
        proxy_buffering off;
        proxy_cache off;

        # CORS
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
    }
}
