# ========================================
# ë¡œì»¬ ê°œë°œìš© Dockerfile (ARM64/AMD64 ë„¤ì´í‹°ë¸Œ)
# ========================================
# Stage 1: Build Stage (ë¹Œë“œ í™˜ê²½)
# ========================================
# í”Œë«í¼ ì§€ì • ì—†ìŒ - ë¡œì»¬ ë¨¸ì‹ ì˜ ë„¤ì´í‹°ë¸Œ ì•„í‚¤í…ì²˜ ì‚¬ìš© (M1/M2/M3ëŠ” ARM64)
# eclipse-temurinì€ ARM64 ì§€ì›, ì§ì ‘ gradle ì„¤ì¹˜
FROM eclipse-temurin:17-jdk-alpine AS build

# Gradle ìˆ˜ë™ ì„¤ì¹˜ (ARM64 í˜¸í™˜)
RUN apk add --no-cache bash wget unzip && \
    wget https://services.gradle.org/distributions/gradle-8.5-bin.zip && \
    unzip gradle-8.5-bin.zip && \
    mv gradle-8.5 /opt/gradle && \
    rm gradle-8.5-bin.zip && \
    ln -s /opt/gradle/bin/gradle /usr/bin/gradle

WORKDIR /app

# Gradle ìºì‹œ ìµœì í™” (ì˜ì¡´ì„± íŒŒì¼ë§Œ ë¨¼ì € ë³µì‚¬)
COPY build.gradle settings.gradle ./
COPY gradle ./gradle

# ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ (ìºì‹± ë ˆì´ì–´ - ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
RUN gradle dependencies --no-daemon || true

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY src ./src

# JAR ë¹Œë“œ (ê°œë°œ ëª¨ë“œ - í…ŒìŠ¤íŠ¸ ìŠ¤í‚µ)
RUN echo "ğŸš€ ë¡œì»¬ ê°œë°œ ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ìŠ¤í‚µ)" && \
    gradle bootJar --no-daemon -x test

# ========================================
# Stage 2: Runtime Stage (ì‹¤í–‰ í™˜ê²½)
# ========================================
# ë„¤ì´í‹°ë¸Œ í”Œë«í¼ ì‚¬ìš© (M1/M2/M3ì—ì„œ 5-10ë°° ë¹ ë¦„)
# amazoncorrettoëŠ” ARM64 ì§€ì›
FROM amazoncorretto:17-alpine

# ë³´ì•ˆ íŒ¨ì¹˜ ì ìš© ë° í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜
RUN apk upgrade --no-cache && \
    apk add --no-cache wget curl && \
    rm -rf /var/cache/apk/*

WORKDIR /app

# ë¹Œë“œ ìŠ¤í…Œì´ì§€ì—ì„œ JAR íŒŒì¼ë§Œ ë³µì‚¬ (ì†ŒìŠ¤ ì½”ë“œ ë¯¸í¬í•¨)
COPY --from=build /app/build/libs/*.jar app.jar

# ë¹„root ìœ ì € ìƒì„± ë° ê¶Œí•œ ì„¤ì •
RUN addgroup -S spring && \
    adduser -S spring -G spring && \
    chown -R spring:spring /app

# ë³´ì•ˆ: ë¹„root ìœ ì €ë¡œ ì „í™˜
USER spring:spring

# í—¬ìŠ¤ì²´í¬ ì„¤ì • (ê°œë°œ í™˜ê²½ - ë” ìì£¼ ì²´í¬)
HEALTHCHECK --interval=15s --timeout=3s --start-period=30s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1

# í¬íŠ¸ ë…¸ì¶œ (ë¬¸ì„œí™” ëª©ì )
EXPOSE 8080

# JVM ë©”ëª¨ë¦¬ ìµœì í™” ì˜µì…˜ (ê°œë°œ í™˜ê²½ìš© - ë” ê´€ëŒ€í•œ ì„¤ì •)
ENV JAVA_OPTS="-Xms512m -Xmx1g -XX:+UseG1GC"

# ë³´ì•ˆ ê°•í™” JVM ì˜µì…˜
ENV JAVA_SECURITY_OPTS="-Djava.security.egd=file:/dev/./urandom"

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS $JAVA_SECURITY_OPTS -jar app.jar"]

# ë©”íƒ€ë°ì´í„°
LABEL maintainer="travel-platform-dev"
LABEL version="1.0.0-dev"
LABEL description="Travel Platform Backend - Local Development (Native ARM64/AMD64)"
