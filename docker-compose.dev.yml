# ========================================
# Î°úÏª¨ Í∞úÎ∞ú ÌôòÍ≤ΩÏö© Docker Compose
# ========================================
# ÏÇ¨Ïö©Î≤ï: docker compose -f docker-compose.dev.yml up -d
# Ï§ëÏßÄ: docker compose -f docker-compose.dev.yml down

networks:
  travel-network:
    driver: bridge

volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local

services:
  # ======================================
  # MySQL (Î°úÏª¨ Í∞úÎ∞úÏö©)
  # ======================================
  mysql-db:
    image: mysql:8.0.35
    container_name: travel-mysql-dev
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: Asia/Seoul
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - travel-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
    security_opt:
      - no-new-privileges:true

  # ======================================
  # Redis (Î°úÏª¨ Í∞úÎ∞úÏö©)
  # ======================================
  redis-cache:
    image: redis:7.2.3-alpine
    container_name: travel-redis-dev
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    networks:
      - travel-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    security_opt:
      - no-new-privileges:true

  # ======================================
  # MailHog (Î°úÏª¨ ÌÖåÏä§Ìä∏Ïö©)
  # ======================================
  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: travel-mailhog-dev
    restart: unless-stopped
    ports:
      - "${MAILHOG_SMTP_PORT:-1025}:1025"
      - "${MAILHOG_UI_PORT:-8025}:8025"
    networks:
      - travel-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8025"]
      interval: 10s
      timeout: 5s
      retries: 3
    security_opt:
      - no-new-privileges:true

  # ======================================
  # Spring Boot Î∞±ÏóîÎìú (Î°úÏª¨ Í∞úÎ∞úÏö© - ARM64 ÎÑ§Ïù¥Ìã∞Î∏å)
  # ======================================
  spring-app:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev  # üöÄ Í∞úÎ∞úÏö© Dockerfile ÏÇ¨Ïö©
    container_name: travel-backend-dev
    restart: unless-stopped
    ports:
      - "${SERVER_PORT:-8080}:8080"
    environment:
      # Spring Profile
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-local}

      # Database
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-db:3306/${MYSQL_DATABASE}?useSSL=false&serverTimezone=Asia/Seoul&characterEncoding=UTF-8
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD}

      # Redis
      SPRING_DATA_REDIS_HOST: redis-cache
      SPRING_DATA_REDIS_PORT: 6379
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD}

      # Mail (MailHog SMTP)
      SPRING_MAIL_HOST: mailhog
      SPRING_MAIL_PORT: 1025
      SPRING_MAIL_USERNAME: ''
      SPRING_MAIL_PASSWORD: ''
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH: 'false'
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE: 'false'

      # JWT
      JWT_SECRET: ${JWT_SECRET}

      # OAuth - Google
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_NAME: ${GOOGLE_CLIENT_NAME}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_AUTHORIZATION_GRANT_TYPE: ${GOOGLE_AUTHORIZATION_GRANT_TYPE}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_SCOPE: ${GOOGLE_SCOPE}

      # OAuth - Naver (Registration)
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_NAVER_CLIENT_NAME: ${NAVER_CLIENT_NAME}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_NAVER_CLIENT_ID: ${NAVER_CLIENT_ID}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_NAVER_CLIENT_SECRET: ${NAVER_CLIENT_SECRET}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_NAVER_REDIRECT_URI: ${NAVER_REDIRECT_URI}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_NAVER_AUTHORIZATION_GRANT_TYPE: ${NAVER_AUTHORIZATION_GRANT_TYPE}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_NAVER_SCOPE: ${NAVER_SCOPE}

      # OAuth - Naver (Provider)
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_NAVER_AUTHORIZATION_URI: ${NAVER_AUTHORIZATION_URI}
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_NAVER_TOKEN_URI: ${NAVER_TOKEN_URI}
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_NAVER_USER_INFO_URI: ${NAVER_USER_INFO_URI}
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_NAVER_USER_NAME_ATTRIBUTE: ${NAVER_USER_NAME_ATTRIBUTE}

      # JVM Options (Í∞úÎ∞ú ÌôòÍ≤Ω - Îçî Í¥ÄÎåÄ)
      JAVA_OPTS: '-Xms512m -Xmx1g -XX:+UseG1GC'

    depends_on:
      mysql-db:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
      mailhog:
        condition: service_healthy

    networks:
      - travel-network

    security_opt:
      - no-new-privileges:true

    # Î¶¨ÏÜåÏä§ Ï†úÌïú (Í∞úÎ∞ú ÌôòÍ≤Ω - Îçî Í¥ÄÎåÄ)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

  # ======================================
  # Next.js ÌîÑÎ°†Ìä∏ÏóîÎìú (Î°úÏª¨ Í∞úÎ∞úÏö© - ARM64 ÎÑ§Ïù¥Ìã∞Î∏å)
  # ======================================
  next-app:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev  # üöÄ Í∞úÎ∞úÏö© Dockerfile ÏÇ¨Ïö©
    container_name: travel-frontend-dev
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8080}
      NEXT_TELEMETRY_DISABLED: 1

    depends_on:
      - spring-app

    networks:
      - travel-network

    # Hot ReloadÎ•º ÏúÑÌïú Î≥ºÎ•® ÎßàÏö¥Ìä∏ (Í∞úÎ∞ú ÌïÑÏàò!)
    volumes:
      - ./frontend:/app
      - /app/node_modules

    security_opt:
      - no-new-privileges:true

    # Î¶¨ÏÜåÏä§ Ï†úÌïú (Í∞úÎ∞ú ÌôòÍ≤Ω - Îçî Í¥ÄÎåÄ)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
