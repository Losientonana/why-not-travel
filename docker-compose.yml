version: '3.8'

# ========================================
# 네트워크 정의
# ========================================
networks:
  travel-network:
    driver: bridge

# ========================================
# 볼륨 정의 (데이터 영속성)
# ========================================
volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local

# ========================================
# 서비스 정의
# ========================================
services:
  # ======================================
  # MySQL (AWS RDS 대체)
  # ======================================
  mysql-db:
    image: mysql:8.0.35
    container_name: travel-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: Asia/Seoul
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - travel-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
    # 보안 강화
    security_opt:
      - no-new-privileges:true

  # ======================================
  # Redis (AWS ElastiCache 대체)
  # ======================================
  redis-cache:
    image: redis:7.2.3-alpine
    container_name: travel-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    networks:
      - travel-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    # 보안 강화
    security_opt:
      - no-new-privileges:true

  # ======================================
  # MailHog (AWS SES 대체 - 로컬 테스트용)
  # ======================================
  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: travel-mailhog
    restart: unless-stopped
    ports:
      - "${MAILHOG_SMTP_PORT:-1025}:1025"
      - "${MAILHOG_UI_PORT:-8025}:8025"
    networks:
      - travel-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8025"]
      interval: 10s
      timeout: 5s
      retries: 3
    # 보안 강화
    security_opt:
      - no-new-privileges:true

  # ======================================
  # Spring Boot 백엔드
  # ======================================
  spring-app:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        SKIP_TESTS: "true"  # 개발: true, 프로덕션: false
    container_name: travel-backend
    restart: unless-stopped
    ports:
      - "${SERVER_PORT:-8080}:8080"
    environment:
      # Spring Profile
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILE:-local}

      # Database (호스트명은 서비스명 'mysql-db' 사용)
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-db:3306/${MYSQL_DATABASE}?useSSL=false&serverTimezone=Asia/Seoul&characterEncoding=UTF-8
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD}

      # Redis (호스트명은 서비스명 'redis-cache' 사용)
      SPRING_DATA_REDIS_HOST: redis-cache
      SPRING_DATA_REDIS_PORT: 6379
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD}

      # Mail (MailHog SMTP)
      SPRING_MAIL_HOST: mailhog
      SPRING_MAIL_PORT: 1025
      SPRING_MAIL_USERNAME: ''
      SPRING_MAIL_PASSWORD: ''
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH: 'false'
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE: 'false'

      # JWT
      JWT_SECRET: ${JWT_SECRET}

      # OAuth - Google
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_NAME: ${GOOGLE_CLIENT_NAME}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_AUTHORIZATION_GRANT_TYPE: ${GOOGLE_AUTHORIZATION_GRANT_TYPE}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_SCOPE: ${GOOGLE_SCOPE}

      # OAuth - Naver (Registration)
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_NAVER_CLIENT_NAME: ${NAVER_CLIENT_NAME}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_NAVER_CLIENT_ID: ${NAVER_CLIENT_ID}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_NAVER_CLIENT_SECRET: ${NAVER_CLIENT_SECRET}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_NAVER_REDIRECT_URI: ${NAVER_REDIRECT_URI}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_NAVER_AUTHORIZATION_GRANT_TYPE: ${NAVER_AUTHORIZATION_GRANT_TYPE}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_NAVER_SCOPE: ${NAVER_SCOPE}

      # OAuth - Naver (Provider)
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_NAVER_AUTHORIZATION_URI: ${NAVER_AUTHORIZATION_URI}
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_NAVER_TOKEN_URI: ${NAVER_TOKEN_URI}
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_NAVER_USER_INFO_URI: ${NAVER_USER_INFO_URI}
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_NAVER_USER_NAME_ATTRIBUTE: ${NAVER_USER_NAME_ATTRIBUTE}

      # JVM Options
      JAVA_OPTS: '-Xms256m -Xmx512m -XX:+UseG1GC'

    depends_on:
      mysql-db:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
      mailhog:
        condition: service_healthy

    networks:
      - travel-network

    # 보안 강화
    security_opt:
      - no-new-privileges:true

    # 리소스 제한 (개발 환경)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    # 읽기 전용 파일시스템 (선택적 - 개발 시 비활성화 가능)
    # read_only: true
    # tmpfs:
    #   - /tmp:size=100M,mode=1777

  # ======================================
  # Next.js 프론트엔드
  # ======================================
  next-app:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development  # 개발 모드, 프로덕션은 'production' 사용
    container_name: travel-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8080}
      NEXT_TELEMETRY_DISABLED: 1

    depends_on:
      - spring-app

    networks:
      - travel-network

    # Hot Reload를 위한 볼륨 마운트 (개발 필수!)
    volumes:
      - ./frontend:/app
      - /app/node_modules
      # .next 폴더는 컨테이너 내부에서 생성하도록 함 (권한 문제 방지)
      # - /app/.next

    # 보안 강화
    security_opt:
      - no-new-privileges:true

    # 리소스 제한 (개발 환경)
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
